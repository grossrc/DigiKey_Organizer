<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Checkout Parts</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    body { margin:0; background:#0b0f14; color:#fff; font-family: system-ui, sans-serif; }
    header { padding:16px; border-bottom:1px solid rgba(255,255,255,.12); display:flex; align-items:center; gap:12px; }
    a.btn { text-decoration:none; }
    .container { padding:16px; }
    .list { display:grid; gap:10px; }
    .row { display:grid; grid-template-columns: 1fr 180px 120px 140px; gap:10px; align-items:center;
           padding:12px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:#11161d; }
    .row small { opacity:.8; }
    .btn { appearance:none; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10); color:#fff;
           padding:.5rem .8rem; border-radius:10px; font-weight:600; cursor:pointer; font-size:.95rem; text-align:center; }
    .btn.primary { background:#2b67f6; border-color:#2b67f6; }
    .empty { opacity:.8; padding:20px; text-align:center; border:1px dashed rgba(255,255,255,.2); border-radius:12px; }
    .toast { position: fixed; left:50%; transform:translateX(-50%); bottom: 16px; background:#121820; border:1px solid rgba(255,255,255,.2);
             padding:10px 14px; border-radius:10px; display:none; }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <header>
    <a class="btn" href="/">‚Üê Home</a>
    <h2 style="margin:0">Checkout Parts</h2>
  </header>

  <div class="container">
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">No parts currently available in storage.</div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const list = document.getElementById('list');
    const empty = document.getElementById('empty');
    const toast = document.getElementById('toast');

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1800);
    }

    async function load() {
      list.innerHTML = '';
      empty.style.display = 'none';

      const res = await fetch('/api/available_parts');
      const data = await res.json();
      if (!data.ok) { list.innerHTML = '<div class="empty">Error loading list</div>'; return; }

      const items = data.items || [];
      if (!items.length) { empty.style.display = 'block'; return; }

      for (const it of items) {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div>
            <div style="font-weight:700">${it.mpn}</div>
            <small>${it.manufacturer || ''}</small>
          </div>
          <div><small>Bin</small><div>${it.position_code}</div></div>
          <div><small>Qty</small><div>${it.qty_on_hand}</div></div>
          <div><button class="btn primary">Checkout</button></div>
        `;
        const btn = row.querySelector('button');
        btn.onclick = async () => {
          btn.disabled = true;
          try {
            const r = await fetch('/api/checkout_part', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ part_id: it.part_id, position_code: it.position_code })
            });
            const j = await r.json();
            if (!j.ok) throw new Error(j.error || 'Checkout failed');
            showToast(`Checked out ${j.moved} from ${it.position_code}`);
            // Refresh list after success
            await load();
          } catch (e) {
            alert(e.message);
            btn.disabled = false;
          }
        };
        list.appendChild(row);
      }
    }

    load();
  </script>
</body>
</html>
