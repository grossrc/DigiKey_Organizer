{% extends "catalog/catalog_base.html" %}
{% block content %}
  <div class="crumbs with-back">
    <button type="button" class="btn-back" id="btnBack" title="Back">‚Üê Back</button>
    <a href="{{ url_for('catalog_dendrogram') }}">All Categories</a>
    {% if category_path_names and category_path_names|length %}
      {% for seg in category_path_names %}
        {% set prefix = category_path_names[:loop.index] %}
        {% set qpath = prefix|join('>') %}
        ‚Ä∫ <a class="crumb-link{% if not loop.last %} crumb-ancestor{% endif %}" href="{{ url_for('catalog_dendrogram') }}?path={{ qpath | urlencode }}">{{ seg }}</a>
      {% endfor %}
    {% else %}
      ‚Ä∫ <span>{{ category_name or category_id }}</span>
    {% endif %}
  </div>
  <h1 class="page-title">
    {% if category_path_names and category_path_names|length %}
      {{ category_path_names[-1] }}
    {% else %}
      {{ category_name or category_id }}
    {% endif %}
  </h1>
  <script>
    (function(){
      const btn = document.getElementById('btnBack');
      if(!btn) return;
      btn.addEventListener('click', function(){
        try {
          const ref = document.referrer || '';
          const sameOrigin = ref.startsWith(location.origin);
          if (sameOrigin) {
            history.back();
            return;
          }
        } catch(_){}
        // Fallback to dendrogram if no safe history
        window.location = "{{ url_for('catalog_dendrogram') }}";
      });
    })();
  </script>

  {% if profile_exists is defined and not profile_exists %}
    <div class="panel note">
      <strong>Note:</strong> This category does not have a parsing profile yet. Parts in this
      category were matched from the raw DigiKey lookup and may be missing
      extracted attributes. If you intend to reference this category often, consider creating a profile to improve extraction and
      classification. Reformat the database afterwards to reflect the change.
    </div>
  {% endif %}

  <div class="layout">
    <aside class="sidebar">
      <div class="panel">
        <div class="panel-title">Filter</div>
        <input id="freetext" class="input" type="search" placeholder="Search MPN / Manufacturer / Attribute">
        <div class="panel-note">Type to filter table rows.</div>
      </div>

      <!-- My List (unique items, no qty) -->
      <div class="panel" id="listPanel">
        <div class="panel-title">My List <span id="listCount" class="muted">(0)</span></div>
        <div id="listItems" class="mini-list empty-state">No items yet. Click ‚ÄúAdd to List‚Äù.</div>
        <div class="list-actions">
          <div class="actions-grid two-rows">
            <button class="btn primary block" id="btnDownloadQR"  title="Download a QR code of the list">Download QR</button>
            <button class="btn block"          id="btnDownloadCSV" title="Download CSV file">Download CSV</button>
            <button class="btn danger ghost block span-2" id="btnClearList" title="Clear list">Clear List</button>
          </div>
          <div class="panel-note">List is stored in this browser only.</div>
        </div>

      </div>

      <div class="panel">
        <div class="panel-title">Stats</div>
        <div class="panel-kv">
          <div>Parts:</div><div>{{ parts|length }}</div>
          <div>Total Qty:</div><div>{{ parts|sum(attribute="qty") }}</div>
        </div>
      </div>
    </aside>

    <section class="content">
      {% if parts|length == 0 %}
        <div class="empty">No in-stock parts in this category.</div>
      {% else %}
        <table class="tbl" id="partsTable">
          <thead>
            <tr>
              <th>Image</th>
              <th>MPN & Description</th>
              <th>Manufacturer</th>
              <th>Qty</th>
              <th>Bin(s)</th>
              <th>Attributes</th>
              <th>Datasheet</th>
              <th>Product</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for p in parts %}
            {% set attrs = p.attributes or {} %}
            {% set display_order = p.display_order or [] %}
            {% set keys = attrs.keys()|list %}
            {% if display_order and display_order|length > 0 %}
              {% set top_keys = [] %}
              {% for k in display_order %}
                {% if k in attrs and top_keys|length < 4 %}
                  {% set _ = top_keys.append(k) %}
                {% endif %}
              {% endfor %}
              {% for k in keys %}
                {% if k not in top_keys and top_keys|length < 4 %}
                  {% set _ = top_keys.append(k) %}
                {% endif %}
              {% endfor %}
              {% set more_keys = ((keys)|reject('in', top_keys)|list) %}
            {% else %}
              {% set top_keys = keys[:4] %}
              {% set more_keys = keys[4:] %}
            {% endif %}
            {# Build a flattened search string including mpn, manufacturer, description and attribute key/values #}
            {% set _attr_kv = [] %}
            {% for k, v in attrs.items() %}
              {% if v is sequence and v is not string %}
                {% set _ = _attr_kv.append(k ~ ' ' ~ (v|join(' '))) %}
              {% else %}
                {% set _ = _attr_kv.append(k ~ ' ' ~ (v|string)) %}
              {% endif %}
            {% endfor %}
            {% set search_text = (p.mpn or '') ~ ' ' ~ (p.manufacturer or '') ~ ' ' ~ (p.description or p.detailed or '') ~ ' ' ~ (_attr_kv|join(' ')) %}

            <tr class="part-row"
                data-part='{{ {
                  "part_id": p.part_id,
                  "mpn": p.mpn,
                  "manufacturer": p.manufacturer,
                  "description": p.description or p.detailed,
                  "category_id": category_id,
                  "image_url": p.image_url,
                  "datasheet_url": p.datasheet_url,
                  "product_url": p.product_url
                } | tojson | e }}'
                data-mpn="{{ p.mpn|e }}"
                data-mfr="{{ (p.manufacturer or '')|e }}"
                data-attrs="{{ (p.attributes|tojson)|e }}"
                data-search="{{ search_text|e }}">

              <td class="cell-img">
                {% if p.image_url %}
                  <img class="thumb" alt="Image of {{ p.mpn }}" src="{{ p.image_url }}">
                {% else %}
                  <div class="thumb thumb-placeholder">No image</div>
                {% endif %}
              </td>

              <td class="cell-mpn">
                <div class="mpn">
                  {{ p.mpn }}
                  <!-- Copy MPN icon -->
                  <button class="icon-btn copy-mpn" title="Copy MPN" aria-label="Copy MPN">üìã</button>
                </div>
                <div class="desc">{{ p.description or p.detailed }}</div>
              </td>

              <td>{{ p.manufacturer or '' }}</td>
              <td class="cell-qty">{{ p.qty }}</td>

              <!-- Bins: bin codes only -->
              <td class="cell-bins">
                {% if p.bins and p.bins|length %}
                  {% for b in p.bins[:4] %}
                    <span class="bin-pill">{{ b.position }}</span>
                  {% endfor %}
                  {% if p.bins|length > 4 %}
                    <span class="bin-more" title="{{ p.bins|tojson }}">+{{ p.bins|length - 4 }} more</span>
                  {% endif %}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>

              <td class="cell-attrs">
                {% if top_keys|length == 0 %}
                  ‚Äî
                {% else %}
                  <div class="attr-list">
                    {% for k in top_keys %}
                      <div class="attr"><span class="k">{{ k.replace('_',' ') }}{% if k == 'iout_max_a' %} (A){% endif %}</span><span class="v">
                        {% set v = attrs[k] %}
                        {% if v is sequence and v is not string %}
                          {% if k == 'iout_max_a' %}
                            {{ '%.5g' % v }}
                          {% else %}
                            {{ v|join(', ') }}
                          {% endif %}
                        {% else %}
                            {% if v is number and v is not integer %}
                              {% if k == 'iout_max_a' %}
                                {{ '%.5g' % v }}
                              {% else %}
                                {{ '%.5g' % v }}
                              {% endif %}
                            {% else %}
                              {{ v }}
                            {% endif %}
                        {% endif %}
                      </span></div>
                    {% endfor %}
                  </div>
                  {% if more_keys|length > 0 %}
                  <details class="attr-details"><summary>More</summary>
                    <div class="attr-list">
                      {% for k in more_keys %}
                        <div class="attr"><span class="k">{{ k.replace('_',' ') }}{% if k == 'iout_max_a' %} (A){% endif %}</span><span class="v">
                          {% set v = attrs[k] %}
                          {% if v is sequence and v is not string %}
                            {% if k == 'iout_max_a' %}
                              {{ '%.5g' % v }}
                            {% else %}
                              {{ v|join(', ') }}
                            {% endif %}
                          {% else %}
                              {% if v is number and v is not integer %}
                                {% if k == 'iout_max_a' %}
                                  {{ '%.5g' % v }}
                                {% else %}
                                  {{ '%.5g' % v }}
                                {% endif %}
                              {% else %}
                                {{ v }}
                              {% endif %}
                          {% endif %}
                        </span></div>
                      {% endfor %}
                    </div>
                  </details>
                  {% endif %}
                {% endif %}
              </td>

              <td class="cell-link">
                {% if p.datasheet_url %}
                  <a class="link" href="{{ p.datasheet_url }}" target="_blank" rel="noopener">Datasheet ‚Üó</a>
                {% else %} ‚Äî {% endif %}
              </td>
              <td class="cell-link">
                {% if p.product_url %}
                  <a class="link" href="{{ p.product_url }}" target="_blank" rel="noopener">Product ‚Üó</a>
                {% else %} ‚Äî {% endif %}
              </td>

              <td class="cell-actions">
                <button class="btn-mini add-to-list">Add to List</button>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </section>
  </div>
{% endblock %}
